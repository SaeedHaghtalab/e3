sudo: enabled
dist: trusty
language: generic

branches:
  only:
    - master
git:
  submodules: false
  
addons:
  hosts:
    - ioctest

  
env:
  - TARGET=${HOME}/build/1 SESSION=1 BASE=3.15.5  REQUIRE=3.0.0  BUILDING_MOD=ctia4
  - TARGET=${HOME}/build/2 SESSION=2 BASE=3.15.5  REQUIRE=3.0.2  BUILDING_MOD=ctia4
  - TARGET=${HOME}/build/3 SESSION=3 BASE=7.0.1.1 REQUIRE=3.0.2  BUILDING_MOD=ctia
  
before_install:
  - sudo apt-get -qq update > /dev/null 2>&1  
  - sudo apt-get install -y realpath ipmitool libtool automake re2c tclx build-essential libreadline-dev libxt-dev x11proto-print-dev libxmu-headers libxmu-dev libxmu6 libxpm-dev libxmuu-dev libxmuu1 libpcre++-dev libsnmp-dev re2c darcs python-dev libnetcdf-dev libhdf5-dev libpng-dev libbz2-dev libxml2-dev libusb-dev libusb-1.0-0-dev libudev-dev tree screen > /dev/null 2>&1  
  - cp -r $TRAVIS_BUILD_DIR ${TARGET} && cd ${TARGET} && echo ${PWD}

install:
  - bash e3_building_test.bash -t ${TARGET}/.epics -b ${BASE} -r ${REQUIRE}

script:
  - bash e3.bash -${BUILDING_MOD} all2
  - bash e3.bash -${BUILDING_MOD} cmd
  - source ${TARGET}/.epics/base-${BASE}/require/${REQUIRE}/bin/setE3Env.bash
  - |
    echo "logfile ${TARGET}/output.log"  > ${TARGET}/.screenrc
    echo "logfile flush 1"              >> ${TARGET}/.screenrc
    echo "log on"                       >> ${TARGET}/.screenrc
    echo "logtstamp after 1"            >> ${TARGET}/.screenrc
    echo "logtstamp on"                 >> ${TARGET}/.screenrc
  - cat ${TARGET}/.screenrc 
  - screen -c ${TARGET}/.screenrc -dm -L -S ${SESSION} /bin/bash -c "iocsh.bash .cmd"
  - sleep 2
  - cat ${TARGET}/output.log
  - screen -X -S ${SESSION} kill


  
 